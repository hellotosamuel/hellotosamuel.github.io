<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essay Practice App (GCE 'N' Level)</title> <!-- Title Updated -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <!-- Tippy.js -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <!-- Optional: Tippy.js theme CSS -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css"/>
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #6c757d;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #212529;
            --highlight-color: #216E00;
            --white: #fff;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --disabled-color: #adb5bd;
            --disabled-bg: #e9ecef;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-gray);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 850px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- Header --- */
        .app-header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .app-header h1 {
            font-size: 1.4em;
            margin: 0;
            color: var(--white);
        }
        .header-cta {
            background-color: var(--white);
            color: var(--primary-color);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease;
            margin-top: 0px;
        }
        .header-cta:hover {
            background-color: #eee;
        }

        /* --- General Styles --- */
        h2 { font-size: 1.4em; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 0.4em; margin-top: 1.5em; margin-bottom: 1em;}
        h3 { font-size: 1.15em; font-weight: 600; margin-top: 1.2em; margin-bottom: 0.5em; color: #333; }
        p, label, .sub-label { margin-bottom: 0.75em; }
        input[type="text"], input[type="password"] { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; box-sizing: border-box; margin-bottom: 10px; }
        input[type="text"]:focus, input[type="password"]:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(0, 90, 156, 0.2); }
        button { background-color: var(--primary-color); color: var(--white); border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: 500; transition: background-color 0.2s ease, opacity 0.2s ease, box-shadow 0.2s ease; display: inline-block; width: auto; margin-top: 10px; text-align: center; }
        button:disabled { background-color: var(--secondary-color); cursor: not-allowed; opacity: 0.7; }
        button:not(:disabled):hover { background-color: #004a80; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button.secondary { background-color: var(--secondary-color); }
        button.secondary:not(:disabled):hover { background-color: #5a6268; }

        .form-section { background-color: var(--white); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid var(--border-color); }
        .form-section label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .sub-label { font-size: 0.9em; color: var(--secondary-color); display: block; margin-top: -5px; margin-bottom: 15px; }

        /* Radio Button Styling */
        .radio-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .radio-option { border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; cursor: pointer; transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; position: relative; background-color: var(--white); }
        .radio-option input[type="radio"] { opacity: 0; position: absolute; width: 0; height: 0; }
        .radio-option .option-label { display: block; margin: 0; cursor: pointer; }
        .radio-option .option-line-1 { font-weight: bold; display: block; margin-bottom: 5px;}
        .radio-option .option-line-2 { font-size: 0.9em; color: var(--secondary-color); display: block; }
        .radio-option.selected { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 90, 156, 0.3); background-color: #e9f5ff; }
        .radio-option.disabled-option { background-color: var(--disabled-bg); color: var(--disabled-color); cursor: not-allowed; border-color: var(--border-color); box-shadow: none; opacity: 0.7; }
        .radio-option.disabled-option .option-line-1, .radio-option.disabled-option .option-line-2 { color: var(--disabled-color); }
        .radio-option.disabled-option .option-label { cursor: not-allowed; }

        /* Specific Section Styling */
        #question-display-area { background-color: #e9f5ff; border: 1px solid #bde0fe; border-left: 5px solid var(--primary-color); padding: 20px; border-radius: 4px; margin-top: 20px; position: sticky; top: 60px; z-index: 10; margin-bottom: 20px; }
        #question-display-area h2 { margin-top: 0; border-bottom: none; color: var(--primary-color); }
        #question-text { font-weight: 500; font-size: 1.1em; line-height: 1.5;}

        /* Guiding Questions & Writing Guide Areas */
        #guiding-questions-area .markdown-content,
        #writing-guide-area .markdown-content { border: 1px solid var(--border-color); padding: 15px 20px; border-radius: 4px; background-color: #fdfdfd; }
        /* Basic Markdown styles */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { margin-top: 1em; margin-bottom: 0.5em; padding-bottom: 0.2em; border-bottom: 1px solid #eee; color: var(--primary-color);}
        .markdown-content h1 { font-size: 1.5em; } .markdown-content h2 { font-size: 1.3em; } .markdown-content h3 { font-size: 1.1em; color: #333; }
        .markdown-content ul { margin-left: 20px; padding-left: 20px; list-style: disc; } .markdown-content li { margin-bottom: 0.5em; }
        .markdown-content p { margin-bottom: 1em; } .markdown-content strong { font-weight: 600; } .markdown-content em { font-style: italic; }
        .markdown-content pre { background-color: var(--light-gray); border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }

        /* Word on Click Styling */
        .markdown-content .word {
            text-decoration: underline;
            color: var(--highlight-color);
            cursor: pointer;
            text-decoration-style: dotted;
            font-weight: 500; /* Make them slightly bolder */
        }
        /* Tippy Pop-up Styling */
        .tippy-box[data-theme~='light'] { /* Example */
            font-size: 0.9em;
            text-align: left;
        }
        .tippy-content {
            padding: 5px 9px;
        }


        .hidden { display: none; }
        .message-area { margin-top: 15px; padding: 10px 15px; border-radius: 4px; text-align: center; font-weight: 500; }
        .error-message { color: var(--danger-color); background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .success-message { color: var(--success-color); background-color: #d4edda; border: 1px solid #c3e6cb; }
        .loading-message { color: var(--secondary-color); font-style: italic; }

        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .app-header { position: static; }
            .app-header h1 { font-size: 1.2em; }
            .header-cta { padding: 6px 10px; font-size: 0.9em; }
            .container { padding: 15px; }
            #question-display-area { position: static; top: auto; margin-bottom: 15px; }
            button { padding: 10px 15px; font-size: 0.95em; }
            .radio-group { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <h1>Essay Practice App (GCE 'N' Level)</h1> <!-- Header Updated -->
        <button class="header-cta" onclick="window.location.href='mailto:samuel@webisig.com';">Contact</button>
    </header>

    <div class="container">

        <p class="instructions">Select an essay type, generate a question, specify your topic, get guiding questions, and a writing guide with clickable vocabulary definitions.</p>

        <!-- Step 1: Setup -->
        <div class="form-section" id="setup-section">
            <h2>1. Setup</h2>
            <div class="form-group">
                 <label for="api-key-input">Enter Key</label>
                 <input type="password" id="api-key-input" placeholder="Enter the provided key">
                 <div class="sub-label">Key required for all AI-powered features.</div>
            </div>
            <div class="form-group">
                 <label>Select Essay Type:</label>
                 <div class="radio-group" id="essay-type-radios"></div>
            </div>
            <button id="generate-question-btn">Generate A Question</button>
            <div id="message-area-setup" class="message-area hidden"></div>
        </div>

        <!-- Step 2: Generated Question -->
        <div class="form-section hidden" id="question-display-area">
            <h2>2. Generated Question</h2>
            <p id="question-text">...</p>
        </div>

        <!-- Step 3: User Topic Input -->
        <div class="form-section hidden" id="topic-input-area">
            <h2>3. Your Focus</h2>
            <div class="form-group">
                <label for="user-topic-input">What would you like to write about based on this question?</label>
                <input type="text" id="user-topic-input" placeholder="e.g., My favourite song 'Count On Me Singapore'">
                <div class="sub-label">Provide a brief idea or angle for your essay. This helps tailor the guiding questions and guide.</div>
            </div>
            <button id="generate-guiding-questions-btn">Generate Guiding Questions</button>
            <div id="message-area-topic" class="message-area hidden"></div>
        </div>

        <!-- Step 4: Guiding Questions -->
        <div class="form-section hidden" id="guiding-questions-area">
            <h2>4. Guiding Questions</h2>
            <p>Use these tailored questions to brainstorm ideas before writing.</p>
            <div id="guiding-questions-content" class="markdown-content">
                 <p class="loading-message">Generating guiding questions...</p>
            </div>
            <button id="generate-guide-btn" class="hidden">Generate Writing Guide</button>
            <div id="message-area-guiding" class="message-area hidden"></div>
        </div>

        <!-- Step 5: Writing Guide -->
        <div class="form-section hidden" id="writing-guide-area">
            <h2>5. Writing Guide</h2>
             <p>Click on underlined words for simple definitions.</p> <!-- Added instruction -->
            <div id="guide-content-markdown" class="markdown-content">
                <p class="loading-message">Generating guide...</p>
            </div>
        </div>

        <!-- Step 6: Vocabulary Area REMOVED -->

    </div>

    <script>
        // --- Configuration ---
        const essayTypes = { // Using N-Level examples
             "Descriptive": { sample: "Describe a piece of music...", enabled: true, examples: [ "Describe a piece of music or a song that is important to you. When did you first hear it, and why does it mean so much to you?", "Describe an important possession which you have kept for a long time and explain why it means a lot to you.", "Describe a family celebration you enjoyed and explain what made it special for you.", "Describe someone you admire and explain what makes this person special to you.", "Describe the sights and sounds of a festival in Singapore or another country." ] },
             "Personal Reflective": { sample: "Write about a time when you received some exciting news...", enabled: true, examples: [ "Write about a time when you received some exciting news. Describe how the news affected you or people around you.", "Write about a special memory from your primary school days and say why you still remember it.", "Write about a time when a meal at a restaurant went wrong.", "Write about a time when you helped someone in your neighbourhood. What did you do and what difference did it make?", "Write about a goal you have achieved and what helped you succeed.", "Write about a time when an unexpected guest arrived at your home.", "Write about some of the games which you played when you were a child and explain why you remember them.", "Write about an occasion when you changed your opinion about someone because they surprised you by being kind." ] },
             "Argumentative": { sample: "'It's much easier to be friends with people who like the same things as we do.'", enabled: true, examples: [ "'It's much easier to be friends with people who like the same things as we do.' How far do you agree?", "We go to school to learn facts and get qualifications, not to make friends and socialise.' What are your views?", "Some people think that being rich and famous always leads to happiness. Do you agree?", "'It is more important for young people to spend time with their friends in real life rather than just chat with them online.' What is your opinion?", "'People of different generations have a lot to learn from one another.' How far do you agree?" ] },
             "Discursive": { sample: "What are the advantages and disadvantages...", enabled: false, examples: [ "What are the advantages and disadvantages of living in a large city?", "Some people prefer to shop online while others like to visit shopping centres. Which do you prefer and why?" ] }
        };

        const API_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

        // --- DOM Elements ---
        // (Removed references to old vocabulary section)
        const apiKeyInput = document.getElementById('api-key-input');
        const essayTypeRadiosContainer = document.getElementById('essay-type-radios');
        const generateQuestionBtn = document.getElementById('generate-question-btn');
        const setupMessageArea = document.getElementById('message-area-setup');
        const questionDisplayArea = document.getElementById('question-display-area');
        const questionTextElement = document.getElementById('question-text');
        const topicInputArea = document.getElementById('topic-input-area');
        const userTopicInput = document.getElementById('user-topic-input');
        const generateGuidingQuestionsBtn = document.getElementById('generate-guiding-questions-btn');
        const topicMessageArea = document.getElementById('message-area-topic');
        const guidingQuestionsArea = document.getElementById('guiding-questions-area');
        const guidingQuestionsContent = document.getElementById('guiding-questions-content');
        const generateGuideBtn = document.getElementById('generate-guide-btn');
        const guidingMessageArea = document.getElementById('message-area-guiding');
        const writingGuideArea = document.getElementById('writing-guide-area');
        const guideContentMarkdown = document.getElementById('guide-content-markdown');
        // const vocabularyArea = REMOVED
        // const showVocabBtn = REMOVED
        // const vocabularyContent = REMOVED
        // const vocabLoadingElement = REMOVED
        // const vocabMessageArea = REMOVED

        // --- State Variables ---
        let apiKey = null;
        let selectedEssayType = null;
        let generatedQuestion = '';
        let generatedGuidingQuestions = '';
        let generatedGuideMarkdown = ''; // Holds the raw markdown *before* word wrapping
        let processedGuideHtml = ''; // Holds the final HTML with spans
        let tippyInstances = []; // To manage Tippy instances if needed later

        // --- CACHE for Definitions ---
        let definitionCache = {};

        // --- Showdown Initialisation ---
        let showdownConverter;
        if (typeof showdown !== 'undefined') {
             showdownConverter = new showdown.Converter({
                 ghCompatibleHeaderId: true,
                 simpleLineBreaks: true, // Convert single newlines to <br>
                 strikethrough: true,
                 tables: true
                 // No need to sanitize if we trust our span injection, but keep an eye on it
                 // sanitize: false, // Be careful with this if enabling complex HTML from AI
             });
            console.log("Showdown library loaded successfully.");
        } else { console.warn("Showdown library not found. Markdown will be displayed as raw text."); }

        // --- BASE GUIDING QUESTIONS ---
        const baseGuidingQuestions = { /* ... Same content as before ... */
             Descriptive: `...`, PersonalReflective: `...`, Argumentative: `...`, Discursive: `...`
        };
        // (Populate with full text - omitted for brevity)
         baseGuidingQuestions.Descriptive = `
Introduction
- How can I create an engaging opening sentence to capture the reader's attention?
- What is the overall scene or subject I will be describing?
- What is the main impression or feeling I want to convey to the reader?

Paragraph 1 (setting the scene)
- What are the sights that dominate the scene? What colors, shapes, and sizes do I notice?
- What sounds can be heard? Are they loud or soft, distinct or muffled?
- What smells are present in the air? Are they pleasant or unpleasant, strong or faint?
- What textures can be felt? Are they rough or smooth, hard or soft?

Paragraph 2 (Focusing on a Specific Element)
- Is there a particular object or person that stands out in the scene?
- What are the specific details about this element that make it interesting or significant?
- How can I use figurative language (similes, metaphors, personification) to describe this element vividly?

Paragraph 3 (Incorporating Action or Emotion)
- Is there any action taking place in the scene? How can I describe the movements and interactions?
- What emotions do I feel when observing this scene? How can I convey these feelings through my writing?
- How does this scene connect to a broader theme or idea?

Conclusion
- How can I summarise the main impressions I have described?
- What is the lasting feeling or thought I want to leave with the reader?
- How can I create a sense of closure to the essay?
            `.trim();
        baseGuidingQuestions.PersonalReflective = `
Introduction:
- Identify a personal experience that was significant due to a lesson learned, a change in perspective, or strong emotions. Choose one specific experience to focus on.
- Consider how to begin your essay with an engaging hook to immediately capture the reader's attention. Think about using a vivid image, a moment of tension, or a relevant question.
- Determine the essential background information needed for the reader to understand the context of your experience. Ensure this information is concise.
- Clarify the main feeling or central idea you aim to explore through your reflection on this experience.

Body Paragraphs

- Describing the Experience:
  - Pinpoint the crucial events or key moments that occurred during the experience. Focus on the most important aspects.
  - Recall what you observed through your senses: sight, hearing, smell, taste, and touch. Use sensory details to create a vivid and immersive narrative for the reader.
  - Identify if there was a specific moment that stands out prominently in your memory of the experience.
  - Consider how to employ descriptive language to effectively illustrate what happened, rather than simply stating the events.

- Reflecting on Thoughts and Feelings:
  - Reflect on your initial thoughts and emotions as the experience unfolded.
  - Consider if your emotions changed during the experience. If so, explore how and why these changes occurred.
  - Identify some of the key thoughts that you had at different points throughout the experience.
  - Explain the reasons behind your emotional and mental responses to the events as they happened.
  - Reflect on any internal conflicts or moments of realization that you experienced during this time.

- Lessons Learned and Significance (Optional):
  - Determine the most significant lesson or key takeaway that you gained from this experience.
  - Consider how this experience has influenced your perspective on yourself, on others, or on the world around you.
  - Reflect on whether this experience has led to any changes in your beliefs, attitudes, or behavior.
  - Explore the broader significance or deeper meaning of this experience in the context of your own life.
  - Consider if you can connect this personal experience to any universal themes or broader ideas.

Conclusion
- Think about how to briefly summarize the main insights or key lessons that you have reflected upon in your essay.
- Determine a final thought, feeling, or message that you want to leave with the reader at the end of your essay.
- Consider how you can bring your essay to a satisfying and thoughtful conclusion, providing a sense of closure.
- Reflect on the lasting impact that this experience has had on you and how you might articulate this in your conclusion.
            `.trim();
        baseGuidingQuestions.Argumentative = `
Introduction:
- Hook: How can I grab the reader's attention immediately (e.g., surprising fact, thought-provoking question, common misconception)?
- Background: What essential context does the reader need about this topic? Why is this issue important or debated?
- Thesis Statement: What is my clear stance on the issue? What are the main reasons (briefly mentioned) supporting my stance? (Optional: Hint at a counter-argument I'll address).

Body Paragraph 1 (Supporting Point 1)
- Topic Sentence: What is the first main reason supporting my thesis?
- Explanation: Why is this reason valid? How does it work or what are its implications?
- Evidence/Example: What specific real-world example, fact, or statistic proves this point? (Avoid purely personal stories unless appropriate for the prompt).
- Link: How does this specific point reinforce my overall thesis statement?

Body Paragraph 2 (Supporting Point 2)
- Topic Sentence: What is the second distinct reason supporting my thesis?
- Explanation: How can I elaborate on this second reason? What makes it significant?
- Evidence/Example: What different evidence or example supports this second point?
- Link: How does this second point further strengthen my main argument (thesis)?

Body Paragraph 3: Counter-Argument & Rebuttal (Recommended):
- Acknowledge Counter-Argument: What is a common opposing view to my stance? How can I state it fairly?
- Rebuttal: Why is my argument stronger than this opposing view? What are the weaknesses or limitations of the counter-argument? How can I respectfully disprove it and reinforce my original point?

Conclusion:
- Restate Thesis (Rephrased): How can I express my main argument again using different words?
- Summarize Main Points: What were the key reasons I used to support my thesis? (Briefly remind the reader).
- Concluding Statement: What final thought, reflection, or call to action can I leave the reader with? How can I provide a sense of closure?
            `.trim();
        baseGuidingQuestions.Discursive = `
Introduction:
- Hook: How can I engage the reader with the topic (e.g., relevant observation, question about its complexity)?
- Background: What is the topic, and why is it complex or debatable? What are the different sides or facets involved?
- Focus Statement: What specific perspectives or aspects of the topic will this essay explore? (Outline the scope without taking a side).

Body Paragraph 1: Perspective/Aspect 1:
- Topic Sentence: What is the first main viewpoint or aspect of the topic I will discuss?
- Explanation: What are the key ideas, arguments, or characteristics associated with this perspective?
- Examples/Illustrations: What specific examples or situations demonstrate this viewpoint in action?

Body Paragraph 2: Perspective/Aspect 2:
- Topic Sentence: What is a different (often contrasting) viewpoint or aspect of the topic?
- Explanation: What are the main arguments or details related to this second perspective?
- Examples/Illustrations: What different examples illustrate this second viewpoint?

Body Paragraph 3: Synthesis/Analysis (Optional but Recommended):
- Relationship: How do the perspectives discussed connect, conflict, or interact with each other?
- Analysis: What are the strengths and weaknesses of each perspective?
- Nuances: Are there any complexities, grey areas, or specific conditions that affect the issue? How does context matter?

Conclusion:
- Summarize Perspectives: What were the main viewpoints or aspects explored in the essay? (Briefly recap).
- Balanced Concluding Thought: What final statement reflects the complexity of the issue without strongly favouring one side? (Acknowledge the multiple facets).
- Final Reflection/Insight: What broader thought or insight about the topic can I leave the reader with? How can I emphasize the multifaceted nature of the issue?
            `.trim();

        // --- PROMPT ENGINEERING STRATEGIES ---
        const promptStrategies = {
            // Generates the initial question
            createAiQuestionPrompt: (essayType) => {
                 const examples = essayTypes[essayType]?.examples || []; let exampleText = ""; if (examples.length > 0) { exampleText = `Base your generation on the style, topic range, and difficulty of these typical GCE 'N' Level ${essayType} questions:\n`; const examplesToShow = examples.slice(0, 3); examplesToShow.forEach(ex => { exampleText += `- "${ex}"\n`; }); } else { exampleText = `For example, a question relevant to the topic "${essayTypes[essayType]?.sample || 'general themes'}".`; }
                 const prompt = `
You are assisting a Singapore GCE 'N' Level student preparing for their English Language exam (Paper 1, Section C Continuous Writing).
Your task is to generate ONE completely new, random, and suitable essay question of the "${essayType}" type.
The question must be appropriate for a 16-year-old student in Singapore. Strictly use British English spelling and phrasing (e.g., colour, organise).
${exampleText}
IMPORTANT: Generate a question that is *inspired by* the examples but is *distinct* and *not* a direct copy or slight rephrasing of any single example provided. Ensure variety.
Respond ONLY with the generated essay question text itself. Do not add any surrounding text, explanations, or quotation marks unless the question itself requires them.`;
                 console.log(`Generating ${essayType} question with AI prompt`); return prompt.trim();
            },
            // Generates tailored guiding questions
            createGuidingQuestionsPrompt: (essayType, question, userTopic) => {
                const baseQuestions = baseGuidingQuestions[essayType] || baseGuidingQuestions.Descriptive; const prompt = `
You are assisting a Singapore GCE 'N' Level student (${essayType} essay).
The essay question is: "${question.trim()}"
The student's specific focus/topic is: "${userTopic.trim() || 'Not specified'}"
Your task is to generate a set of guiding questions to help the student brainstorm ideas for their essay. Use the following base structure and questions provided for the "${essayType}" essay type as a starting point:
--- BASE QUESTIONS for ${essayType} ---
${baseQuestions}
--- END BASE QUESTIONS ---
IMPORTANT: Adapt and tailor these base questions specifically to the context of the essay question ("${question.trim()}") and the student's chosen topic ("${userTopic.trim() || 'Not specified'}"). Rephrase the questions naturally using details from the question and topic. Make them directly relevant to brainstorming *for this specific essay*. Maintain the section structure (e.g., Introduction, Body Paragraph 1, etc.) from the base questions. Keep the language simple and encouraging. Ensure all generated questions and text use British English spelling and phrasing (e.g., summarise, analyse). Respond ONLY with the adapted guiding questions in Markdown format (use bold for section titles like **Introduction**, and use '-' / '  -' for sub-questions). Do not include any other introductory or concluding text.`;
                console.log("Generating guiding questions prompt"); return prompt.trim();
            },
            // Generates the RAW writing guide markdown
            createGuidePrompt: (essayType, question, userTopic) => {
                const commonInstructions = `
You are assisting a Singapore GCE 'N' Level student.
The essay question is: "${question.trim()}"
The essay type is: ${essayType}.
The student wants to focus on: "${userTopic.trim() || 'Not specified'}"
The student has already brainstormed using tailored guiding questions based on this context.
Now, provide a detailed writing guide (around 280-350 words total) in standard Markdown format. Strictly use British English spelling and phrasing (e.g., organise, colour). The target audience is a secondary school student in Singapore. The points must be brief guides requiring elaboration. Suggest key ideas, techniques, or details. The final essay word count should be around 400 words. Structure the output clearly using Markdown bold headings as specified below for the "${essayType}" type. Respond ONLY with the guide content in standard Markdown. Do NOT include any HTML tags or pre-wrap any words yet.`; // Added instruction NOT to add HTML yet
                let specificInstructions = '';
                 switch (essayType) {
                    case 'Descriptive': specificInstructions = `Structure the guide strictly as follows:\n**Hook Examples:** (...)\n**Introduction:** (...)\n**Body Paragraphs:** (...)\n**Conclusion:** (...)\n`; break; // Content same as before
                    case 'Personal Reflective': specificInstructions = `Structure the guide strictly as follows:\n**Question Analysis:** (...)\n**Hook Examples:** (...)\n**Introduction:** (...)\n**Body Paragraphs:** (...)\n**Conclusion:** (...)\n`; break; // Content same as before
                    case 'Argumentative': specificInstructions = `Structure the guide strictly as follows:\n**Hook Examples:** (...)\n**Introduction:** (...)\n**Body Paragraphs (Supporting Points):** (...)\n**Counter-Argument & Rebuttal:** (...)\n**Conclusion:** (...)\n`; break; // Content same as before
                    case 'Discursive': specificInstructions = `Structure the guide strictly as follows:\n**Hook Examples:** (...)\n**Introduction:** (...)\n**Body Paragraphs (Exploring Perspectives):** (...)\n**Synthesis/Analysis (Optional):** (...)\n**Conclusion:** (...)\n`; break; // Content same as before
                    default: console.error(`Guide generation called for unsupported type: ${essayType}`); return `Error: Guide generation for type "${essayType}" is not currently supported.`;
                 }
                // Re-populate detailed instructions for brevity above
                if(essayType === 'Descriptive') specificInstructions = `Structure the guide strictly as follows:\n**Hook Examples:** (Provide exactly 3 distinct hook sentences relevant to the question and user focus. Use Singapore context naturally.)\n**Introduction:** (1-2 points outlining subject/scene based on question and user focus, establishing the main mood/impression.)\n**Body Paragraphs:** (Suggest 3-4 body paragraphs. For each, provide 1-2 bullet points focusing on developing specific sensory details, atmosphere, feelings, or a specific aspect related to user focus and question. Suggest specific Singapore context or elements where appropriate. Encourage varied sentence structure and vocabulary.)\n**Conclusion:** (1-2 points summarising the overall impression or key feeling related to user focus, providing a sense of closure.)\n`;
                else if (essayType === 'Personal Reflective') specificInstructions = `Structure the guide strictly as follows:\n**Question Analysis:** (Briefly re-iterate the core theme/idea of the question.)\n**Hook Examples:** (Provide exactly 3 distinct hook sentences relevant to the question and user focus. Use Singapore context naturally.)\n**Introduction:** (1-2 points setting scene/context based on user focus and linking to the question's core idea/theme.)\n**Body Paragraphs:** (Suggest 3-4 body paragraphs following the 'Describing Experience', 'Reflecting', and optional 'Lessons Learned' flow. For each, provide 1-2 bullet points guiding the student through specific moments, thoughts, feelings, development, challenges, or lessons learned related to user focus and question theme. Suggest specific Singapore context or elements where appropriate. Encourage reflection and showing rather than telling.)\n**Conclusion:** (1-2 points summarising the significance, reflection, or lesson learned related to user focus and question theme. Provide a final impactful thought.)\n`;
                else if (essayType === 'Argumentative') specificInstructions = `Structure the guide strictly as follows:\n**Hook Examples:** (Provide exactly 3 distinct hook sentences relevant to the question/topic, perhaps a surprising fact or question.)\n**Introduction:** (1-2 points briefly explaining the issue and context, leading to a clear thesis statement stating the student's likely stance, or suggesting how to form one if topic not specified.)\n**Body Paragraphs (Supporting Points):** (Suggest 2-3 paragraphs. For each, provide 1-2 bullet points outlining a clear supporting reason, suggesting types of evidence/examples relevant to the topic, and linking back to the thesis.)\n**Counter-Argument & Rebuttal:** (Suggest 1 paragraph. Guide on fairly stating an opposing view and then providing 1-2 bullet points on how to refute it effectively, strengthening the original thesis.)\n**Conclusion:** (1-2 points rephrasing the thesis, briefly summarizing the main supporting points, and offering a final thought or call to action related to the topic.)\n`;
                else if (essayType === 'Discursive') specificInstructions = `Structure the guide strictly as follows:\n**Hook Examples:** (Provide exactly 3 distinct hook sentences relevant to the question/topic, perhaps highlighting its complexity or relevance.)\n**Introduction:** (1-2 points introducing the topic, explaining its debatable nature, and outlining the different perspectives/aspects (related to user topic if provided) that will be explored.)\n**Body Paragraphs (Exploring Perspectives):** (Suggest 2-3 paragraphs. For each paragraph focusing on a different perspective/aspect of the topic, provide 1-2 bullet points outlining the key ideas/arguments and suggesting relevant examples/illustrations.)\n**Synthesis/Analysis (Optional):** (If appropriate, suggest 1 paragraph guiding the student to compare/contrast the perspectives, discuss nuances, or analyze strengths/weaknesses.)\n**Conclusion:** (1-2 points summarizing the different perspectives explored, offering a balanced concluding thought that reflects the complexity without taking a strong stance, and providing a final insight.)\n`;

                const fullPrompt = (commonInstructions + specificInstructions).trim();
                console.log("Generating raw guide prompt"); return fullPrompt;
            },
            // *** NEW: Prompt to wrap words in the guide text ***
            createWordWrappingPrompt: (guideText) => {
                const prompt = `
You are processing a pre-generated writing guide for a GCE 'N' Level student.
Your task is to identify challenging or advanced vocabulary words/two-word phrases that might be difficult for 13-year-olds within the provided text.
Identify approximately 10-18 such words, aiming for less than 10% of the total word count.
Wrap ONLY these identified words/phrases with the specific HTML span: <span class="word" data-word="ACTUAL_WORD">ACTUAL_WORD</span>. Replace ACTUAL_WORD with the exact word/phrase.
Do NOT wrap common words. Do NOT wrap words like 'Literal', 'Figurative', 'Contrast', 'Articulate'.
Crucially, return the ENTIRE original guide text, modified ONLY by adding these specific HTML spans around the selected words.
Do NOT change any other part of the text, formatting, or markdown structure. Do NOT add any commentary.

Here is the guide text:
--- GUIDE TEXT START ---
${guideText}
--- GUIDE TEXT END ---

Return the complete text with the specified spans added.`;
                console.log("Generating word wrapping prompt"); return prompt.trim();
            },
             // *** NEW: Prompt to define a single word ***
            createWordDefinitionPrompt: (wordToDefine) => {
                const prompt = `
You are assisting a Singapore GCE 'N' Level student.
Provide a very simple, clear, and concise definition or explanation for the word/phrase: "${wordToDefine.trim()}".
The explanation should be suitable for a secondary school student and use simple, understandable language.
Maximum 15 words for the definition.
Strictly use British English spelling (e.g., organise, analyse).
Respond ONLY with the definition text itself. Do not add "Definition:", quotation marks, or any other surrounding text.`;
                console.log(`Generating definition prompt for: ${wordToDefine}`); return prompt.trim();
            }
            // createVocabPrompt REMOVED
        };

        // --- Functions ---
        function populateRadioButtons() { /* ... same as previous ... */
             essayTypeRadiosContainer.innerHTML = ''; Object.keys(essayTypes).forEach((typeKey, index) => { const typeData = essayTypes[typeKey]; const optionDiv = document.createElement('div'); optionDiv.classList.add('radio-option'); if (!typeData.enabled) { optionDiv.classList.add('disabled-option'); } const inputId = `radio-type-${index}`; const radioInput = document.createElement('input'); radioInput.type = 'radio'; radioInput.id = inputId; radioInput.name = 'essay_type'; radioInput.value = typeKey; radioInput.disabled = !typeData.enabled; radioInput.addEventListener('change', (event) => { document.querySelectorAll('.radio-option').forEach(div => div.classList.remove('selected')); if (event.target.checked) { selectedEssayType = event.target.value; console.log("Selected type:", selectedEssayType); event.target.closest('.radio-option').classList.add('selected'); hideMessage(setupMessageArea); if (selectedEssayType === 'Argumentative' || selectedEssayType === 'Discursive') { userTopicInput.placeholder = "Optional. You can click the button below to proceed."; } else { userTopicInput.placeholder = "e.g., My favourite song 'Count On Me Singapore'"; } if (!questionDisplayArea.classList.contains('hidden')) { resetUI(); } } }); let displaySample = typeData.sample; if (typeData.examples && typeData.examples.length > 0) { const randomIndex = Math.floor(Math.random() * typeData.examples.length); displaySample = typeData.examples[randomIndex]; } const label = document.createElement('label'); label.htmlFor = inputId; label.classList.add('option-label'); label.innerHTML = `<span class="option-line-1">${typeKey}</span><span class="option-line-2">E.g. â€“ ${escapeHtml(displaySample)}</span>`; optionDiv.appendChild(radioInput); optionDiv.appendChild(label); essayTypeRadiosContainer.appendChild(optionDiv); });
        }
        function parseMarkdown(markdownText) { if (showdownConverter) { try { return showdownConverter.makeHtml(markdownText); } catch (error) { console.error("Showdown conversion failed:", error); return `<p><em>Markdown parsing failed. Displaying raw text:</em></p><pre>${escapeHtml(markdownText)}</pre>`; } } else { return `<p><em>Markdown library not loaded. Displaying raw text:</em></p><pre>${escapeHtml(markdownText)}</pre>`; } }
        function escapeHtml(unsafe) { return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        async function callGemini(promptText, callingFunction) { apiKey = apiKeyInput.value; if (!apiKey) throw new Error("API Key is required for this operation. Please enter it above."); const requestBody = { contents: [{ parts: [{ text: promptText }] }], safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" } ], generationConfig: { maxOutputTokens: 1800 } }; console.log(`Sending request from ${callingFunction} with prompt (truncated):`, promptText.substring(0, 150) + "..."); try { const response = await fetch(`${API_ENDPOINT}?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) }); const responseData = await response.json(); if (!response.ok) { console.error("API Error Response:", responseData); const errMsg = responseData.error?.message || `HTTP ${response.status}`; throw new Error(`API Error: ${errMsg}. Check API key/model.`); } console.log(`API Success Response for ${callingFunction} (truncated):`, JSON.stringify(responseData).substring(0, 200) + "..."); if (responseData.promptFeedback?.blockReason) { console.error("API blocked response:", responseData.promptFeedback); throw new Error(`Content blocked by safety filter: ${responseData.promptFeedback.blockReason}`); } if (!responseData.candidates?.[0]?.content?.parts?.[0]?.text) { console.warn("API returned unexpected or empty response structure:", responseData); throw new Error("API returned empty or unexpected response format."); } return responseData.candidates[0].content.parts[0].text; } catch (error) { console.error(`Error during Gemini API call from ${callingFunction}:`, error); if (error.message.startsWith("API Error:") || error.message.startsWith("Content blocked")) throw error; else throw new Error(`Network/parsing error: ${error.message}`); } }
        function formatVocabulary(text) { /* REMOVED - No longer needed */ return ''; } // Keep function signature if needed elsewhere, but return empty
        function showMessage(message, type = "info", areaElement) { if (!areaElement) { console.warn("showMessage called without specifying an areaElement."); areaElement = setupMessageArea; } areaElement.textContent = message; areaElement.className = 'message-area'; if (type === 'error') areaElement.classList.add('error-message'); else if (type === 'success') areaElement.classList.add('success-message'); else if (type === 'loading') areaElement.classList.add('loading-message'); areaElement.classList.remove('hidden'); }
        function hideMessage(areaElement = null) { const areas = areaElement ? [areaElement] : [setupMessageArea, topicMessageArea, guidingMessageArea /* Removed vocabMessageArea */ ]; areas.forEach(area => { if(area) { area.classList.add('hidden'); area.textContent = ''; area.className = 'message-area hidden'; } }); }
        function resetUI() {
             // Destroy existing Tippy instances before clearing content
             if (tippyInstances && tippyInstances.length > 0) {
                 tippyInstances.forEach(instance => instance.destroy());
                 tippyInstances = []; // Clear the array
             }
            questionDisplayArea.classList.add('hidden'); topicInputArea.classList.add('hidden'); guidingQuestionsArea.classList.add('hidden'); writingGuideArea.classList.add('hidden'); // vocabularyArea is removed
            questionTextElement.textContent = ''; userTopicInput.value = ''; guidingQuestionsContent.innerHTML = ''; guideContentMarkdown.innerHTML = ''; // vocabularyContent is removed
            hideMessage(topicMessageArea); hideMessage(guidingMessageArea); // hideMessage(vocabMessageArea) removed
            generateGuideBtn.classList.add('hidden');
            generatedQuestion = ''; generatedGuidingQuestions = ''; generatedGuideMarkdown = ''; processedGuideHtml = ''; // Clear HTML state too
             // Placeholder reset removed from here
        }

        // --- Event Handlers ---

        // 1. Generate Question
        generateQuestionBtn.addEventListener('click', async () => { /* ... same as previous ... */
             apiKey = apiKeyInput.value; if (!selectedEssayType) { showMessage("Please select an Essay Type.", "error", setupMessageArea); return; } if (!essayTypes[selectedEssayType]?.enabled) { showMessage(`Question generation for type "${selectedEssayType}" is currently disabled.`, "error", setupMessageArea); return; } if (!apiKey) { showMessage("Please enter the provided key.", "error", setupMessageArea); return; } generateQuestionBtn.disabled = true; generateQuestionBtn.textContent = 'Generating...'; hideMessage(setupMessageArea); resetUI(); try { const questionPrompt = promptStrategies.createAiQuestionPrompt(selectedEssayType); generatedQuestion = await callGemini(questionPrompt, 'GenerateQuestion'); console.log(`Generated ${selectedEssayType} question via AI: ${generatedQuestion}`); questionTextElement.textContent = generatedQuestion.trim(); questionDisplayArea.classList.remove('hidden'); topicInputArea.classList.remove('hidden'); if (selectedEssayType === 'Argumentative' || selectedEssayType === 'Discursive') { userTopicInput.placeholder = "Optional. You can click the button below to proceed."; } else { userTopicInput.placeholder = "e.g., My favourite song 'Count On Me Singapore'"; } topicInputArea.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (error) { showMessage(`Error generating question: ${error.message}`, "error", setupMessageArea); resetUI(); } finally { generateQuestionBtn.disabled = false; generateQuestionBtn.textContent = 'Generate A Question'; }
        });

        // 2. Generate Guiding Questions
        generateGuidingQuestionsBtn.addEventListener('click', async () => { /* ... same as previous ... */
             apiKey = apiKeyInput.value; const userTopic = userTopicInput.value.trim(); if (!generatedQuestion || !selectedEssayType) { showMessage("Error: Missing question or essay type context.", "error", topicMessageArea); return; } if (!apiKey) { showMessage("API Key is required to generate guiding questions.", "error", topicMessageArea); return; } generateGuidingQuestionsBtn.disabled = true; generateGuidingQuestionsBtn.textContent = 'Generating...'; hideMessage(topicMessageArea); guidingQuestionsArea.classList.remove('hidden'); guidingQuestionsContent.innerHTML = '<p class="loading-message">Generating guiding questions...</p>'; generateGuideBtn.classList.add('hidden'); hideMessage(guidingMessageArea); writingGuideArea.classList.add('hidden'); /* vocabularyArea removed */ try { const guidingPrompt = promptStrategies.createGuidingQuestionsPrompt(selectedEssayType, generatedQuestion, userTopic); generatedGuidingQuestions = await callGemini(guidingPrompt, 'GenerateGuidingQuestions'); const guidingQuestionsHtml = parseMarkdown(generatedGuidingQuestions); guidingQuestionsContent.innerHTML = guidingQuestionsHtml; generateGuideBtn.classList.remove('hidden'); guidingQuestionsArea.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (error) { showMessage(`Error generating guiding questions: ${error.message}`, "error", topicMessageArea); guidingQuestionsArea.classList.add('hidden'); } finally { generateGuidingQuestionsBtn.disabled = false; generateGuidingQuestionsBtn.textContent = 'Generate Guiding Questions'; }
        });

        // *** 3. Generate Writing Guide (UPDATED FOR 2-STEP AI + TIPPY) ***
        generateGuideBtn.addEventListener('click', async () => {
             apiKey = apiKeyInput.value;
             const userTopic = userTopicInput.value.trim();
             if (!generatedQuestion || !selectedEssayType || !generatedGuidingQuestions) { showMessage("Error: Missing context. Please restart from generating guiding questions.", "error", guidingMessageArea); return; }
             if (!apiKey) { showMessage("API Key is required to generate the writing guide.", "error", guidingMessageArea); return; }

            generateGuideBtn.disabled = true; generateGuideBtn.textContent = 'Generating...';
            hideMessage(guidingMessageArea);
            writingGuideArea.classList.remove('hidden');
            guideContentMarkdown.innerHTML = '<p class="loading-message">Generating guide text...</p>'; // Step 1 loading
            // vocabularyArea REMOVED

            // Destroy any previous Tippy instances
            if (tippyInstances && tippyInstances.length > 0) {
                tippyInstances.forEach(instance => instance.destroy());
                tippyInstances = [];
            }

            try {
                 // --- Step 1: Generate Raw Guide Text ---
                 const guidePrompt = promptStrategies.createGuidePrompt(selectedEssayType, generatedQuestion, userTopic);
                 if (guidePrompt.startsWith('Error:')) { throw new Error(guidePrompt); }
                 generatedGuideMarkdown = await callGemini(guidePrompt, 'GenerateGuide'); // Store raw markdown

                 guideContentMarkdown.innerHTML = '<p class="loading-message">Identifying vocabulary...</p>'; // Step 2 loading

                 // --- Step 2: Identify and Wrap Words ---
                 const wrappingPrompt = promptStrategies.createWordWrappingPrompt(generatedGuideMarkdown);
                 const guideWithSpans = await callGemini(wrappingPrompt, 'WrapWords');

                 // --- Step 3: Parse and Display ---
                 processedGuideHtml = parseMarkdown(guideWithSpans); // Parse the markdown *with* spans
                 guideContentMarkdown.innerHTML = processedGuideHtml; // Display final HTML

                 // --- Step 4: Initialize Tippy ---
                 tippyInstances = tippy(guideContentMarkdown.querySelectorAll('.word'), {
                    content: 'Loading definition...', // Initial placeholder
                    trigger: 'click',           // Use click
                    interactive: true,
                    allowHTML: true,
                    theme: 'light',
                    placement: 'bottom',
                    // appendTo: document.body, // Helps with potential overflow issues

                    async onShow(instance) {
                        const word = instance.reference.dataset.word;
                        if (!word) {
                            instance.setContent('Error: Word not found.');
                            return;
                        }

                        // Check cache first
                        if (definitionCache[word]) {
                            instance.setContent(escapeHtml(definitionCache[word]));
                            console.log(`Cache hit for: ${word}`);
                            return; // Serve from cache
                        }

                        // Not in cache, fetch definition (prevent multiple fetches)
                        if (instance.state.isFetching) return;
                        instance.state.isFetching = true;
                        instance.setContent('Loading...'); // Update content while fetching

                        try {
                             apiKey = apiKeyInput.value; // Re-check key just before call
                             if (!apiKey) throw new Error("API Key missing.");

                            const definitionPrompt = promptStrategies.createWordDefinitionPrompt(word);
                            const definition = await callGemini(definitionPrompt, 'DefineWord');
                            const cleanDefinition = definition.trim();

                            definitionCache[word] = cleanDefinition; // Store in cache
                            instance.setContent(escapeHtml(cleanDefinition)); // Set final content

                        } catch (error) {
                            console.error(`Error fetching definition for "${word}":`, error);
                            // Display specific API error if available, otherwise generic message
                            const displayError = error.message.startsWith('API Error:') || error.message.startsWith('Content blocked') ? error.message : 'Could not fetch definition.';
                            instance.setContent(`Error: ${displayError}`);
                             // Optionally clear cache entry on error? Maybe not, user might retry.
                        } finally {
                             instance.state.isFetching = false;
                        }
                    },
                     onHidden(instance) {
                        // Optional: Reset content on hide, forces reload/cache check next time
                         // instance.setContent('Loading definition...');
                     }
                 });
                 console.log(`Tippy initialized for ${tippyInstances.length} words.`);
                 if (tippyInstances.length === 0) {
                     console.warn("No words were wrapped by the AI for Tippy initialization.");
                     // Optionally display a message to the user if no words were identified
                 }


                 writingGuideArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch(error) {
                showMessage(`Error generating writing guide: ${error.message}`, "error", guidingMessageArea);
                writingGuideArea.classList.add('hidden');
            } finally {
                 generateGuideBtn.disabled = false;
                 generateGuideBtn.textContent = 'Generate Writing Guide';
            }
        });

        // 4. Show Vocabulary Button REMOVED

        // --- Initialisation ---
        populateRadioButtons();
        apiKeyInput.addEventListener('input', () => hideMessage(setupMessageArea));

    </script>

</body>
</html>
